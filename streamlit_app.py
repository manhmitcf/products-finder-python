import streamlit as st
import requests
import pandas as pd
import json
from datetime import datetime
import time

# C·∫•u h√¨nh trang
st.set_page_config(
    page_title="Products Finder - T√¨m ki·∫øm s·∫£n ph·∫©m th√¥ng minh",
    page_icon="üîç",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS t√πy ch·ªânh
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
    }
    .search-box {
        font-size: 1.1rem;
        padding: 0.5rem;
        border-radius: 10px;
        border: 2px solid #1f77b4;
    }
    .result-card {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #1f77b4;
        margin-bottom: 1rem;
    }
    .score-badge {
        background-color: #28a745;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .sidebar-info {
        background-color: #e3f2fd;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
</style>
""", unsafe_allow_html=True)

# H√†m g·ªçi API
def search_products(query, limit=5, api_url="http://localhost:8000"):
    """G·ªçi API ƒë·ªÉ t√¨m ki·∫øm s·∫£n ph·∫©m"""
    try:
        response = requests.post(
            f"{api_url}/search",
            json={"text": query, "limit": limit},
            timeout=30
        )
        if response.status_code == 200:
            return response.json(), None
        else:
            return None, f"L·ªói API: {response.status_code} - {response.text}"
    except requests.exceptions.ConnectionError:
        return None, "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn API. Vui l√≤ng ki·ªÉm tra xem API server ƒë√£ ch·∫°y ch∆∞a."
    except requests.exceptions.Timeout:
        return None, "Timeout: API m·∫•t qu√° nhi·ªÅu th·ªùi gian ƒë·ªÉ ph·∫£n h·ªìi."
    except Exception as e:
        return None, f"L·ªói kh√¥ng x√°c ƒë·ªãnh: {str(e)}"

# H√†m ki·ªÉm tra tr·∫°ng th√°i API
def check_api_status(api_url="http://localhost:8000"):
    """Ki·ªÉm tra xem API c√≥ ho·∫°t ƒë·ªông kh√¥ng"""
    try:
        response = requests.get(f"{api_url}/docs", timeout=5)
        return response.status_code == 200
    except:
        return False

# Header ch√≠nh
st.markdown('<h1 class="main-header">üîç Products Finder</h1>', unsafe_allow_html=True)
st.markdown('<p style="text-align: center; font-size: 1.2rem; color: #666;">T√¨m ki·∫øm s·∫£n ph·∫©m th√¥ng minh v·ªõi c√¥ng ngh·ªá AI</p>', unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.markdown('<div class="sidebar-info">', unsafe_allow_html=True)
    st.markdown("### ‚öôÔ∏è C·∫•u h√¨nh")
    
    # C·∫•u h√¨nh API URL
    api_url = st.text_input(
        "üåê API URL", 
        value="http://localhost:8000",
        help="URL c·ªßa API server"
    )
    
    # S·ªë l∆∞·ª£ng k·∫øt qu·∫£
    limit = st.slider(
        "üìä S·ªë k·∫øt qu·∫£ t·ªëi ƒëa", 
        min_value=1, 
        max_value=20, 
        value=5,
        help="S·ªë l∆∞·ª£ng s·∫£n ph·∫©m t·ªëi ƒëa mu·ªën hi·ªÉn th·ªã"
    )
    
    # Ki·ªÉm tra tr·∫°ng th√°i API
    st.markdown("### üîå Tr·∫°ng th√°i API")
    if st.button("Ki·ªÉm tra k·∫øt n·ªëi"):
        with st.spinner("ƒêang ki·ªÉm tra..."):
            if check_api_status(api_url):
                st.success("‚úÖ API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng")
            else:
                st.error("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn API")
    
    st.markdown('</div>', unsafe_allow_html=True)
    
    # Th√¥ng tin h∆∞·ªõng d·∫´n
    st.markdown("### üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng")
    st.markdown("""
    1. **Nh·∫≠p t·ª´ kh√≥a** t√¨m ki·∫øm v√†o √¥ b√™n d∆∞·ªõi
    2. **Nh·∫•n Enter** ho·∫∑c click n√∫t T√¨m ki·∫øm
    3. **Xem k·∫øt qu·∫£** ƒë∆∞·ª£c s·∫Øp x·∫øp theo ƒë·ªô li√™n quan
    4. **Click v√†o link** ƒë·ªÉ xem chi ti·∫øt s·∫£n ph·∫©m
    """)
    
    # V√≠ d·ª• t√¨m ki·∫øm
    st.markdown("### üí° V√≠ d·ª• t√¨m ki·∫øm")
    example_queries = [
        "ƒëi·ªán tho·∫°i smartphone",
        "laptop gaming",
        "tai nghe bluetooth",
        "ƒë·ªìng h·ªì th√¥ng minh",
        "camera ch·ª•p ·∫£nh"
    ]
    
    for query in example_queries:
        if st.button(f"üîç {query}", key=f"example_{query}"):
            st.session_state.search_query = query

# Kh·ªüi t·∫°o session state
if 'search_history' not in st.session_state:
    st.session_state.search_history = []
if 'search_query' not in st.session_state:
    st.session_state.search_query = ""

# Giao di·ªán t√¨m ki·∫øm ch√≠nh
col1, col2 = st.columns([4, 1])

with col1:
    search_query = st.text_input(
        "üîç Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm:",
        value=st.session_state.search_query,
        placeholder="V√≠ d·ª•: ƒëi·ªán tho·∫°i iPhone, laptop Dell, tai nghe Sony...",
        key="main_search"
    )

with col2:
    st.markdown("<br>", unsafe_allow_html=True)  # Spacer
    search_button = st.button("üöÄ T√¨m ki·∫øm", type="primary")

# X·ª≠ l√Ω t√¨m ki·∫øm
if search_button or (search_query and search_query != st.session_state.get('last_query', '')):
    if search_query.strip():
        st.session_state.last_query = search_query
        
        # Th√™m v√†o l·ªãch s·ª≠ t√¨m ki·∫øm
        if search_query not in st.session_state.search_history:
            st.session_state.search_history.insert(0, search_query)
            if len(st.session_state.search_history) > 10:
                st.session_state.search_history.pop()
        
        # Hi·ªÉn th·ªã loading
        with st.spinner(f"üîç ƒêang t√¨m ki·∫øm '{search_query}'..."):
            results, error = search_products(search_query, limit, api_url)
        
        if error:
            st.error(f"‚ùå {error}")
            
            # G·ª£i √Ω kh·∫Øc ph·ª•c
            st.markdown("### üõ†Ô∏è C√°ch kh·∫Øc ph·ª•c:")
            st.markdown("""
            1. **Ki·ªÉm tra API server**: ƒê·∫£m b·∫£o API ƒëang ch·∫°y t·∫°i `http://localhost:8000`
            2. **Ch·∫°y API**: S·ª≠ d·ª•ng l·ªánh `uvicorn main:app --reload` ho·∫∑c `docker-compose up`
            3. **Ki·ªÉm tra URL**: ƒê·∫£m b·∫£o URL API trong sidebar l√† ch√≠nh x√°c
            """)
            
        elif results:
            # Hi·ªÉn th·ªã k·∫øt qu·∫£
            st.success(f"‚úÖ T√¨m th·∫•y {len(results)} k·∫øt qu·∫£ cho '{search_query}'")
            
            # Tabs cho c√°c c√°ch hi·ªÉn th·ªã kh√°c nhau
            tab1, tab2, tab3 = st.tabs(["üìã Danh s√°ch", "üìä B·∫£ng d·ªØ li·ªáu", "üìà Ph√¢n t√≠ch"])
            
            with tab1:
                # Hi·ªÉn th·ªã d·∫°ng card
                for i, item in enumerate(results, 1):
                    with st.container():
                        st.markdown(f"""
                        <div class="result-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: #1f77b4;">#{i} {item.get('name', 'Kh√¥ng c√≥ t√™n')}</h3>
                                <span class="score-badge">ƒêi·ªÉm: {item.get('score', 0):.3f}</span>
                            </div>
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Th√¥ng tin chi ti·∫øt
                        col1, col2 = st.columns([3, 1])
                        
                        with col1:
                            if item.get('descriptioninfo'):
                                st.write("üìù **M√¥ t·∫£:**", item['descriptioninfo'][:200] + "..." if len(item.get('descriptioninfo', '')) > 200 else item.get('descriptioninfo', ''))
                            
                            if item.get('url'):
                                st.markdown(f"üîó [Xem chi ti·∫øt s·∫£n ph·∫©m]({item['url']})")
                        
                        with col2:
                            # Th√™m c√°c th√¥ng tin kh√°c n·∫øu c√≥
                            st.metric("ƒê·ªô li√™n quan", f"{item.get('score', 0):.1%}")
                        
                        st.divider()
            
            with tab2:
                # Hi·ªÉn th·ªã d·∫°ng b·∫£ng
                df_results = pd.DataFrame(results)
                if not df_results.empty:
                    # L√†m tr√≤n score
                    if 'score' in df_results.columns:
                        df_results['score'] = df_results['score'].round(3)
                    
                    # C·∫Øt ng·∫Øn m√¥ t·∫£
                    if 'descriptioninfo' in df_results.columns:
                        df_results['descriptioninfo'] = df_results['descriptioninfo'].apply(
                            lambda x: x[:100] + "..." if len(str(x)) > 100 else x
                        )
                    
                    st.dataframe(
                        df_results,
                        use_container_width=True,
                        hide_index=True
                    )
                    
                    # N√∫t download
                    csv = df_results.to_csv(index=False, encoding='utf-8-sig')
                    st.download_button(
                        label="üì• T·∫£i xu·ªëng CSV",
                        data=csv,
                        file_name=f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv"
                    )
            
            with tab3:
                # Ph√¢n t√≠ch k·∫øt qu·∫£
                if results:
                    scores = [item.get('score', 0) for item in results]
                    
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        st.metric("ƒêi·ªÉm cao nh·∫•t", f"{max(scores):.3f}")
                    
                    with col2:
                        st.metric("ƒêi·ªÉm trung b√¨nh", f"{sum(scores)/len(scores):.3f}")
                    
                    with col3:
                        st.metric("ƒêi·ªÉm th·∫•p nh·∫•t", f"{min(scores):.3f}")
                    
                    # Bi·ªÉu ƒë·ªì ƒëi·ªÉm s·ªë
                    chart_data = pd.DataFrame({
                        'S·∫£n ph·∫©m': [f"#{i+1}" for i in range(len(results))],
                        'ƒêi·ªÉm t∆∞∆°ng ƒë·ªìng': scores
                    })
                    
                    st.bar_chart(chart_data.set_index('S·∫£n ph·∫©m'))
        else:
            st.warning("ü§∑‚Äç‚ôÇÔ∏è Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.")
    else:
        st.warning("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm.")

# L·ªãch s·ª≠ t√¨m ki·∫øm
if st.session_state.search_history:
    st.markdown("### üìö L·ªãch s·ª≠ t√¨m ki·∫øm")
    
    # Hi·ªÉn th·ªã l·ªãch s·ª≠ d·∫°ng chips
    cols = st.columns(min(len(st.session_state.search_history), 5))
    for i, query in enumerate(st.session_state.search_history[:5]):
        with cols[i]:
            if st.button(f"üîÑ {query}", key=f"history_{i}"):
                st.session_state.search_query = query
                st.rerun()

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 2rem;">
    <p>üöÄ <strong>Products Finder</strong> - Powered by AI & Vector Search</p>
    <p>ƒê∆∞·ª£c ph√°t tri·ªÉn v·ªõi ‚ù§Ô∏è b·∫±ng Streamlit & FastAPI</p>
</div>
""", unsafe_allow_html=True)